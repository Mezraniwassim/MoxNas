{% extends "base.html" %}

{% block title %}Service Management - MoxNAS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0"><i class="bi bi-gear"></i> Service Management</h1>
            {% if current_user.is_admin() %}
            <div class="btn-group">
                <button class="btn btn-success" onclick="performQuickAction('start_essential')">
                    <i class="bi bi-play-circle"></i> Start Essential
                </button>
                <button class="btn btn-warning" onclick="performQuickAction('reload_configs')">
                    <i class="bi bi-arrow-clockwise"></i> Reload Configs
                </button>
                <button class="btn btn-primary" onclick="performQuickAction('restart_all_nas')">
                    <i class="bi bi-arrow-repeat"></i> Restart NAS Services
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Service Status Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Running Services</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="runningServicesCount">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-check-circle text-gray-300" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Stopped Services</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="stoppedServicesCount">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-pause-circle text-gray-300" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Failed Services</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="failedServicesCount">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-x-circle text-gray-300" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Port Check</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="portStatus">
                            <button class="btn btn-sm btn-outline-info" onclick="checkPorts()">
                                <i class="bi bi-wifi"></i> Check
                            </button>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-router text-gray-300" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Services by Category -->
<div id="servicesContainer">
    <!-- Services will be loaded here -->
</div>

<!-- Health Check Results -->
<div class="row mt-4" id="healthCheckContainer" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Health Check Results</h6>
            </div>
            <div class="card-body" id="healthCheckResults">
                <!-- Health check results will be displayed here -->
            </div>
        </div>
    </div>
</div>

<!-- Service Logs Modal -->
<div class="modal fade" id="serviceLogsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Service Logs - <span id="logsServiceName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <label for="logLines" class="form-label">Lines to show:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="logLines">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div id="serviceLogsContent" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.8rem;">
                    <!-- Logs will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Actions Confirmation Modal -->
<div class="modal fade" id="serviceActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Service Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="actionConfirmText">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn" onclick="executeServiceAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentServiceAction = null;
let currentServiceName = null;

// Load services status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadServicesStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(loadServicesStatus, 30000);
});

function loadServicesStatus() {
    fetch('/api/services/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayServices(data.services);
                updateStatusCounts(data.services);
            } else {
                showAlert('Failed to load services status', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading services status:', error);
            showAlert('Error loading services status', 'danger');
        });
}

function displayServices(services) {
    const container = document.getElementById('servicesContainer');
    container.innerHTML = '';
    
    // Service category icons and descriptions
    const categoryInfo = {
        'samba': {
            icon: 'bi-windows',
            title: 'SMB/CIFS Services',
            description: 'Windows file sharing services'
        },
        'nfs': {
            icon: 'bi-ubuntu',
            title: 'NFS Services',
            description: 'Network File System services'
        },
        'ftp': {
            icon: 'bi-upload',
            title: 'FTP Services',
            description: 'File Transfer Protocol services'
        },
        'postgresql': {
            icon: 'bi-database',
            title: 'Database Services',
            description: 'PostgreSQL database server'
        },
        'redis': {
            icon: 'bi-memory',
            title: 'Cache Services',
            description: 'Redis cache and message broker'
        },
        'nginx': {
            icon: 'bi-globe',
            title: 'Web Services',
            description: 'Web server and reverse proxy'
        },
        'supervisor': {
            icon: 'bi-gear',
            title: 'Process Manager',
            description: 'MoxNAS application services'
        },
        'mdadm': {
            icon: 'bi-hdd-rack',
            title: 'RAID Services',
            description: 'RAID array monitoring'
        }
    };
    
    Object.keys(services).forEach(category => {
        const categoryServices = services[category];
        const info = categoryInfo[category] || {
            icon: 'bi-gear',
            title: category.charAt(0).toUpperCase() + category.slice(1),
            description: `${category} services`
        };
        
        const categoryCard = document.createElement('div');
        categoryCard.className = 'row mb-4';
        
        let servicesHtml = '';
        Object.keys(categoryServices).forEach(serviceName => {
            const service = categoryServices[serviceName];
            const statusBadge = getStatusBadge(service.status);
            const enabledBadge = service.enabled ? 
                '<span class="badge bg-success ms-1">Enabled</span>' : 
                '<span class="badge bg-secondary ms-1">Disabled</span>';
            
            const memoryInfo = service.memory_usage ? 
                `${(service.memory_usage / (1024 * 1024)).toFixed(1)} MB` : 'N/A';
            
            servicesHtml += `
                <tr>
                    <td>
                        <i class="bi bi-gear me-2"></i>
                        <strong>${serviceName}</strong>
                        ${enabledBadge}
                    </td>
                    <td>${statusBadge}</td>
                    <td>${service.description || 'N/A'}</td>
                    <td>${service.uptime || 'N/A'}</td>
                    <td>${memoryInfo}</td>
                    <td>${service.pid || 'N/A'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info btn-sm" onclick="viewServiceLogs('${serviceName}')" title="View Logs">
                                <i class="bi bi-file-text"></i>
                            </button>
                            {% if current_user.is_admin() %}
                            ${service.active ? 
                                `<button class="btn btn-outline-warning btn-sm" onclick="confirmServiceAction('stop', '${serviceName}')" title="Stop Service">
                                    <i class="bi bi-stop"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="confirmServiceAction('restart', '${serviceName}')" title="Restart Service">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>` :
                                `<button class="btn btn-outline-success btn-sm" onclick="confirmServiceAction('start', '${serviceName}')" title="Start Service">
                                    <i class="bi bi-play"></i>
                                </button>`
                            }
                            <button class="btn btn-outline-secondary btn-sm" onclick="confirmServiceAction('reload', '${serviceName}')" title="Reload Config">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            `;
        });
        
        categoryCard.innerHTML = `
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="${info.icon} me-2"></i>${info.title}
                                </h6>
                                <small class="text-muted">${info.description}</small>
                            </div>
                            {% if current_user.is_admin() %}
                            <button class="btn btn-sm btn-outline-primary" onclick="restartServiceGroup('${category}')">
                                <i class="bi bi-arrow-repeat"></i> Restart Group
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                        <th>Uptime</th>
                                        <th>Memory</th>
                                        <th>PID</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${servicesHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(categoryCard);
    });
}

function getStatusBadge(status) {
    const badges = {
        'running': '<span class="badge bg-success">Running</span>',
        'stopped': '<span class="badge bg-secondary">Stopped</span>',
        'failed': '<span class="badge bg-danger">Failed</span>',
        'starting': '<span class="badge bg-warning">Starting</span>',
        'stopping': '<span class="badge bg-warning">Stopping</span>',
        'unknown': '<span class="badge bg-secondary">Unknown</span>'
    };
    return badges[status] || badges['unknown'];
}

function updateStatusCounts(services) {
    let runningCount = 0;
    let stoppedCount = 0;
    let failedCount = 0;
    
    Object.keys(services).forEach(category => {
        Object.keys(services[category]).forEach(serviceName => {
            const service = services[category][serviceName];
            switch (service.status) {
                case 'running':
                    runningCount++;
                    break;
                case 'stopped':
                    stoppedCount++;
                    break;
                case 'failed':
                    failedCount++;
                    break;
            }
        });
    });
    
    document.getElementById('runningServicesCount').textContent = runningCount;
    document.getElementById('stoppedServicesCount').textContent = stoppedCount;
    document.getElementById('failedServicesCount').textContent = failedCount;
}

function confirmServiceAction(action, serviceName) {
    currentServiceAction = action;
    currentServiceName = serviceName;
    
    const actionText = {
        'start': `start ${serviceName}`,
        'stop': `stop ${serviceName}`,
        'restart': `restart ${serviceName}`,
        'reload': `reload configuration for ${serviceName}`,
        'enable': `enable ${serviceName} for startup`,
        'disable': `disable ${serviceName} from startup`
    };
    
    document.getElementById('actionConfirmText').textContent = 
        `Are you sure you want to ${actionText[action] || action + ' ' + serviceName}?`;
    
    const modal = new bootstrap.Modal(document.getElementById('serviceActionModal'));
    modal.show();
}

function executeServiceAction() {
    if (!currentServiceAction || !currentServiceName) {
        return;
    }
    
    const actionBtn = document.getElementById('confirmActionBtn');
    const originalText = actionBtn.innerHTML;
    actionBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';
    actionBtn.disabled = true;
    
    fetch(`/api/services/${currentServiceName}/${currentServiceAction}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadServicesStatus(); // Refresh status
        } else {
            showAlert(data.message, 'danger');
        }
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('serviceActionModal')).hide();
    })
    .catch(error => {
        console.error('Error executing service action:', error);
        showAlert('Failed to execute service action', 'danger');
    })
    .finally(() => {
        actionBtn.innerHTML = originalText;
        actionBtn.disabled = false;
        currentServiceAction = null;
        currentServiceName = null;
    });
}

function restartServiceGroup(serviceGroup) {
    if (!confirm(`Are you sure you want to restart all ${serviceGroup.toUpperCase()} services?`)) {
        return;
    }
    
    showAlert(`Restarting ${serviceGroup.toUpperCase()} services...`, 'info');
    
    fetch(`/api/services/group/${serviceGroup}/restart`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => loadServicesStatus(), 3000); // Refresh after delay
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error restarting service group:', error);
        showAlert('Failed to restart service group', 'danger');
    });
}

function performQuickAction(action) {
    if (!confirm('Are you sure you want to perform this action?')) {
        return;
    }
    
    showAlert('Performing action...', 'info');
    
    fetch('/api/services/quick-actions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Action completed successfully', 'success');
            setTimeout(() => loadServicesStatus(), 3000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error performing quick action:', error);
        showAlert('Failed to perform action', 'danger');
    });
}

function viewServiceLogs(serviceName) {
    document.getElementById('logsServiceName').textContent = serviceName;
    currentServiceName = serviceName;
    
    const modal = new bootstrap.Modal(document.getElementById('serviceLogsModal'));
    modal.show();
    
    refreshLogs();
}

function refreshLogs() {
    if (!currentServiceName) return;
    
    const lines = document.getElementById('logLines').value;
    const logsContent = document.getElementById('serviceLogsContent');
    
    logsContent.innerHTML = '<div class="text-center"><div class="spinner-border text-light" role="status"></div></div>';
    
    fetch(`/api/services/${currentServiceName}/logs?lines=${lines}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.logs && data.logs.length > 0) {
                    logsContent.innerHTML = data.logs.map(log => 
                        `<div class="log-line">${escapeHtml(log)}</div>`
                    ).join('');
                } else {
                    logsContent.innerHTML = '<div class="text-muted">No logs available</div>';
                }
            } else {
                logsContent.innerHTML = `<div class="text-danger">Failed to load logs: ${data.message}</div>`;
            }
            
            // Scroll to bottom
            logsContent.scrollTop = logsContent.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            logsContent.innerHTML = '<div class="text-danger">Error loading logs</div>';
        });
}

function checkPorts() {
    const portStatus = document.getElementById('portStatus');
    portStatus.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    
    fetch('/api/services/ports/check')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const openPorts = Object.values(data.ports).filter(p => p.listening).length;
                const totalPorts = Object.keys(data.ports).length;
                
                portStatus.innerHTML = `${openPorts}/${totalPorts} Open`;
                
                // Show detailed port status
                let portDetails = '<div class="mt-2">';
                Object.keys(data.ports).forEach(serviceName => {
                    const port = data.ports[serviceName];
                    const badge = port.listening ? 'bg-success' : 'bg-danger';
                    portDetails += `<span class="badge ${badge} me-1">${serviceName}:${port.port}</span>`;
                });
                portDetails += '</div>';
                
                portStatus.innerHTML += portDetails;
            } else {
                portStatus.innerHTML = '<span class="text-danger">Error</span>';
            }
        })
        .catch(error => {
            console.error('Error checking ports:', error);
            portStatus.innerHTML = '<span class="text-danger">Error</span>';
        });
}

function runHealthCheck() {
    const healthContainer = document.getElementById('healthCheckContainer');
    const healthResults = document.getElementById('healthCheckResults');
    
    healthContainer.style.display = 'block';
    healthResults.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Running comprehensive health check...</p></div>';
    
    fetch('/api/services/health-check')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayHealthReport(data.report);
            } else {
                healthResults.innerHTML = `<div class="alert alert-danger">Failed to run health check: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Error running health check:', error);
            healthResults.innerHTML = '<div class="alert alert-danger">Error running health check</div>';
        });
}

function displayHealthReport(report) {
    const healthResults = document.getElementById('healthCheckResults');
    
    const statusClass = {
        'healthy': 'success',
        'warning': 'warning',
        'critical': 'danger'
    };
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card border-${statusClass[report.overall_status]}">
                    <div class="card-body text-center">
                        <h5 class="card-title text-${statusClass[report.overall_status]}">Overall Status</h5>
                        <h3>${report.overall_status.toUpperCase()}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-4">
                        <div class="text-center">
                            <h4 class="text-primary">${report.summary.total_services}</h4>
                            <small class="text-muted">Total Services</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h4 class="text-danger">${report.summary.critical_issues}</h4>
                            <small class="text-muted">Critical Issues</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h4 class="text-warning">${report.summary.warnings}</h4>
                            <small class="text-muted">Warnings</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (report.critical_issues.length > 0) {
        html += `
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> Critical Issues:</h6>
                <ul class="mb-0">
                    ${report.critical_issues.map(issue => `<li>${issue}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (report.warnings.length > 0) {
        html += `
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-circle"></i> Warnings:</h6>
                <ul class="mb-0">
                    ${report.warnings.map(warning => `<li>${warning}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (report.recommendations.length > 0) {
        html += `
            <div class="alert alert-info">
                <h6><i class="bi bi-lightbulb"></i> Recommendations:</h6>
                <ul class="mb-0">
                    ${report.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    healthResults.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+R to refresh services
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        loadServicesStatus();
    }
    
    // Ctrl+H to run health check
    if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        runHealthCheck();
    }
});
</script>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.log-line {
    margin-bottom: 0.2rem;
    word-break: break-all;
    white-space: pre-wrap;
}

.card-body .row .col-4 h4 {
    margin-bottom: 0.25rem;
}

.service-status-badge {
    font-size: 0.8rem;
}

#serviceLogsContent {
    background-color: #1e1e1e !important;
    color: #d4d4d4;
}

.btn-group-sm > .btn, .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}
</style>
{% endblock %}